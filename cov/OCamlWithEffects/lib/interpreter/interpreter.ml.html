<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>interpreter.ml &mdash; Coverage report</title>
    <meta name="description" content="91.05% coverage in lib/interpreter/interpreter.ml">
    <link rel="stylesheet" href="../../coverage.css"/>
    <script src="../../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../../index.html">
          <span class="dirname">lib/interpreter/</span>interpreter.ml
        </a>
      </h1>
      <h2>91.05%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:8.06%"></span>
      <span class="unvisited" style="top:9.37%"></span>
      <span class="some-visited" style="top:17.65%"></span>
      <span class="unvisited" style="top:18.08%"></span>
      <span class="unvisited" style="top:24.40%"></span>
      <span class="unvisited" style="top:28.32%"></span>
      <span class="unvisited" style="top:29.41%"></span>
      <span class="unvisited" style="top:29.63%"></span>
      <span class="unvisited" style="top:34.86%"></span>
      <span class="unvisited" style="top:46.84%"></span>
      <span class="unvisited" style="top:48.58%"></span>
      <span class="unvisited" style="bottom:45.32%"></span>
      <span class="unvisited" style="bottom:41.83%"></span>
      <span class="unvisited" style="bottom:36.38%"></span>
      <span class="unvisited" style="bottom:36.17%"></span>
      <span class="unvisited" style="bottom:28.32%"></span>
      <span class="unvisited" style="bottom:24.40%"></span>
      <span class="unvisited" style="bottom:18.52%"></span>
      <span class="unvisited" style="bottom:17.65%"></span>
      <span class="unvisited" style="bottom:17.43%"></span>
      <span class="unvisited" style="bottom:14.81%"></span>
      <span class="unvisited" style="bottom:6.54%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span class="visited"> </span>
<a id="L27"></a><span class="visited"> </span>
<a id="L28"></a><span class="visited"> </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span class="visited"> </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span class="visited"> </span>
<a id="L36"></a><span class="visited"> </span>
<a id="L37"></a><span class="unvisited"> </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span > </span>
<a id="L41"></a><span class="visited"> </span>
<a id="L42"></a><span class="visited"> </span>
<a id="L43"></a><span class="unvisited"> </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span > </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span > </span>
<a id="L53"></a><span > </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span class="visited"> </span>
<a id="L56"></a><span class="visited"> </span>
<a id="L57"></a><span class="visited"> </span>
<a id="L58"></a><span > </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span class="visited"> </span>
<a id="L61"></a><span class="visited"> </span>
<a id="L62"></a><span class="visited"> </span>
<a id="L63"></a><span > </span>
<a id="L64"></a><span > </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span > </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span > </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span > </span>
<a id="L73"></a><span > </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span class="visited"> </span>
<a id="L76"></a><span class="visited"> </span>
<a id="L77"></a><span class="visited"> </span>
<a id="L78"></a><span class="visited"> </span>
<a id="L79"></a><span class="visited"> </span>
<a id="L80"></a><span class="visited"> </span>
<a id="L81"></a><span class="some-visited"> </span>
<a id="L82"></a><span > </span>
<a id="L83"></a><span class="unvisited"> </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span > </span>
<a id="L87"></a><span > </span>
<a id="L88"></a><span > </span>
<a id="L89"></a><span > </span>
<a id="L90"></a><span class="visited"> </span>
<a id="L91"></a><span > </span>
<a id="L92"></a><span > </span>
<a id="L93"></a><span class="visited"> </span>
<a id="L94"></a><span class="visited"> </span>
<a id="L95"></a><span class="visited"> </span>
<a id="L96"></a><span class="visited"> </span>
<a id="L97"></a><span class="visited"> </span>
<a id="L98"></a><span > </span>
<a id="L99"></a><span class="visited"> </span>
<a id="L100"></a><span class="visited"> </span>
<a id="L101"></a><span > </span>
<a id="L102"></a><span class="visited"> </span>
<a id="L103"></a><span class="visited"> </span>
<a id="L104"></a><span class="visited"> </span>
<a id="L105"></a><span class="visited"> </span>
<a id="L106"></a><span class="visited"> </span>
<a id="L107"></a><span > </span>
<a id="L108"></a><span class="visited"> </span>
<a id="L109"></a><span class="visited"> </span>
<a id="L110"></a><span > </span>
<a id="L111"></a><span > </span>
<a id="L112"></a><span class="unvisited"> </span>
<a id="L113"></a><span > </span>
<a id="L114"></a><span class="visited"> </span>
<a id="L115"></a><span class="visited"> </span>
<a id="L116"></a><span class="visited"> </span>
<a id="L117"></a><span class="visited"> </span>
<a id="L118"></a><span class="visited"> </span>
<a id="L119"></a><span class="visited"> </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span class="visited"> </span>
<a id="L122"></a><span class="visited"> </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span class="visited"> </span>
<a id="L125"></a><span > </span>
<a id="L126"></a><span class="visited"> </span>
<a id="L127"></a><span class="visited"> </span>
<a id="L128"></a><span class="visited"> </span>
<a id="L129"></a><span > </span>
<a id="L130"></a><span class="unvisited"> </span>
<a id="L131"></a><span class="visited"> </span>
<a id="L132"></a><span class="visited"> </span>
<a id="L133"></a><span class="visited"> </span>
<a id="L134"></a><span class="visited"> </span>
<a id="L135"></a><span class="unvisited"> </span>
<a id="L136"></a><span class="unvisited"> </span>
<a id="L137"></a><span > </span>
<a id="L138"></a><span > </span>
<a id="L139"></a><span > </span>
<a id="L140"></a><span > </span>
<a id="L141"></a><span > </span>
<a id="L142"></a><span > </span>
<a id="L143"></a><span > </span>
<a id="L144"></a><span > </span>
<a id="L145"></a><span > </span>
<a id="L146"></a><span > </span>
<a id="L147"></a><span > </span>
<a id="L148"></a><span > </span>
<a id="L149"></a><span class="visited"> </span>
<a id="L150"></a><span class="visited"> </span>
<a id="L151"></a><span class="visited"> </span>
<a id="L152"></a><span class="visited"> </span>
<a id="L153"></a><span class="visited"> </span>
<a id="L154"></a><span > </span>
<a id="L155"></a><span > </span>
<a id="L156"></a><span > </span>
<a id="L157"></a><span class="visited"> </span>
<a id="L158"></a><span class="visited"> </span>
<a id="L159"></a><span class="visited"> </span>
<a id="L160"></a><span class="unvisited"> </span>
<a id="L161"></a><span > </span>
<a id="L162"></a><span > </span>
<a id="L163"></a><span > </span>
<a id="L164"></a><span > </span>
<a id="L165"></a><span class="visited"> </span>
<a id="L166"></a><span class="visited"> </span>
<a id="L167"></a><span class="visited"> </span>
<a id="L168"></a><span class="visited"> </span>
<a id="L169"></a><span > </span>
<a id="L170"></a><span > </span>
<a id="L171"></a><span class="visited"> </span>
<a id="L172"></a><span class="visited"> </span>
<a id="L173"></a><span > </span>
<a id="L174"></a><span > </span>
<a id="L175"></a><span > </span>
<a id="L176"></a><span class="visited"> </span>
<a id="L177"></a><span class="visited"> </span>
<a id="L178"></a><span > </span>
<a id="L179"></a><span class="visited"> </span>
<a id="L180"></a><span class="visited"> </span>
<a id="L181"></a><span class="visited"> </span>
<a id="L182"></a><span class="visited"> </span>
<a id="L183"></a><span class="visited"> </span>
<a id="L184"></a><span > </span>
<a id="L185"></a><span class="visited"> </span>
<a id="L186"></a><span class="visited"> </span>
<a id="L187"></a><span class="visited"> </span>
<a id="L188"></a><span class="visited"> </span>
<a id="L189"></a><span class="visited"> </span>
<a id="L190"></a><span > </span>
<a id="L191"></a><span class="visited"> </span>
<a id="L192"></a><span class="visited"> </span>
<a id="L193"></a><span class="visited"> </span>
<a id="L194"></a><span class="visited"> </span>
<a id="L195"></a><span class="visited"> </span>
<a id="L196"></a><span > </span>
<a id="L197"></a><span class="visited"> </span>
<a id="L198"></a><span class="visited"> </span>
<a id="L199"></a><span class="visited"> </span>
<a id="L200"></a><span class="visited"> </span>
<a id="L201"></a><span class="visited"> </span>
<a id="L202"></a><span > </span>
<a id="L203"></a><span class="visited"> </span>
<a id="L204"></a><span class="visited"> </span>
<a id="L205"></a><span class="visited"> </span>
<a id="L206"></a><span class="visited"> </span>
<a id="L207"></a><span class="visited"> </span>
<a id="L208"></a><span > </span>
<a id="L209"></a><span class="visited"> </span>
<a id="L210"></a><span class="visited"> </span>
<a id="L211"></a><span class="visited"> </span>
<a id="L212"></a><span class="visited"> </span>
<a id="L213"></a><span class="visited"> </span>
<a id="L214"></a><span > </span>
<a id="L215"></a><span class="unvisited"> </span>
<a id="L216"></a><span > </span>
<a id="L217"></a><span > </span>
<a id="L218"></a><span > </span>
<a id="L219"></a><span > </span>
<a id="L220"></a><span class="visited"> </span>
<a id="L221"></a><span class="visited"> </span>
<a id="L222"></a><span > </span>
<a id="L223"></a><span class="unvisited"> </span>
<a id="L224"></a><span > </span>
<a id="L225"></a><span > </span>
<a id="L226"></a><span > </span>
<a id="L227"></a><span > </span>
<a id="L228"></a><span > </span>
<a id="L229"></a><span > </span>
<a id="L230"></a><span > </span>
<a id="L231"></a><span > </span>
<a id="L232"></a><span class="visited"> </span>
<a id="L233"></a><span class="visited"> </span>
<a id="L234"></a><span class="visited"> </span>
<a id="L235"></a><span class="visited"> </span>
<a id="L236"></a><span class="visited"> </span>
<a id="L237"></a><span class="visited"> </span>
<a id="L238"></a><span class="visited"> </span>
<a id="L239"></a><span class="visited"> </span>
<a id="L240"></a><span class="visited"> </span>
<a id="L241"></a><span class="visited"> </span>
<a id="L242"></a><span class="visited"> </span>
<a id="L243"></a><span class="visited"> </span>
<a id="L244"></a><span class="visited"> </span>
<a id="L245"></a><span class="visited"> </span>
<a id="L246"></a><span class="visited"> </span>
<a id="L247"></a><span class="visited"> </span>
<a id="L248"></a><span > </span>
<a id="L249"></a><span class="visited"> </span>
<a id="L250"></a><span class="visited"> </span>
<a id="L251"></a><span class="unvisited"> </span>
<a id="L252"></a><span > </span>
<a id="L253"></a><span > </span>
<a id="L254"></a><span class="visited"> </span>
<a id="L255"></a><span class="visited"> </span>
<a id="L256"></a><span class="visited"> </span>
<a id="L257"></a><span class="visited"> </span>
<a id="L258"></a><span class="visited"> </span>
<a id="L259"></a><span class="visited"> </span>
<a id="L260"></a><span class="visited"> </span>
<a id="L261"></a><span class="visited"> </span>
<a id="L262"></a><span class="visited"> </span>
<a id="L263"></a><span class="visited"> </span>
<a id="L264"></a><span class="visited"> </span>
<a id="L265"></a><span > </span>
<a id="L266"></a><span class="visited"> </span>
<a id="L267"></a><span class="unvisited"> </span>
<a id="L268"></a><span > </span>
<a id="L269"></a><span class="visited"> </span>
<a id="L270"></a><span class="visited"> </span>
<a id="L271"></a><span class="visited"> </span>
<a id="L272"></a><span class="visited"> </span>
<a id="L273"></a><span class="visited"> </span>
<a id="L274"></a><span class="visited"> </span>
<a id="L275"></a><span class="visited"> </span>
<a id="L276"></a><span class="visited"> </span>
<a id="L277"></a><span class="visited"> </span>
<a id="L278"></a><span class="visited"> </span>
<a id="L279"></a><span class="visited"> </span>
<a id="L280"></a><span class="visited"> </span>
<a id="L281"></a><span class="visited"> </span>
<a id="L282"></a><span class="visited"> </span>
<a id="L283"></a><span class="visited"> </span>
<a id="L284"></a><span class="visited"> </span>
<a id="L285"></a><span class="visited"> </span>
<a id="L286"></a><span class="visited"> </span>
<a id="L287"></a><span > </span>
<a id="L288"></a><span class="visited"> </span>
<a id="L289"></a><span > </span>
<a id="L290"></a><span class="visited"> </span>
<a id="L291"></a><span class="visited"> </span>
<a id="L292"></a><span class="unvisited"> </span>
<a id="L293"></a><span class="unvisited"> </span>
<a id="L294"></a><span class="visited"> </span>
<a id="L295"></a><span class="visited"> </span>
<a id="L296"></a><span class="visited"> </span>
<a id="L297"></a><span class="visited"> </span>
<a id="L298"></a><span class="visited"> </span>
<a id="L299"></a><span class="visited"> </span>
<a id="L300"></a><span class="visited"> </span>
<a id="L301"></a><span class="visited"> </span>
<a id="L302"></a><span class="visited"> </span>
<a id="L303"></a><span class="visited"> </span>
<a id="L304"></a><span class="visited"> </span>
<a id="L305"></a><span class="visited"> </span>
<a id="L306"></a><span class="visited"> </span>
<a id="L307"></a><span class="visited"> </span>
<a id="L308"></a><span class="visited"> </span>
<a id="L309"></a><span class="visited"> </span>
<a id="L310"></a><span class="visited"> </span>
<a id="L311"></a><span > </span>
<a id="L312"></a><span class="visited"> </span>
<a id="L313"></a><span class="visited"> </span>
<a id="L314"></a><span class="visited"> </span>
<a id="L315"></a><span > </span>
<a id="L316"></a><span > </span>
<a id="L317"></a><span class="visited"> </span>
<a id="L318"></a><span > </span>
<a id="L319"></a><span > </span>
<a id="L320"></a><span > </span>
<a id="L321"></a><span class="visited"> </span>
<a id="L322"></a><span class="visited"> </span>
<a id="L323"></a><span > </span>
<a id="L324"></a><span class="visited"> </span>
<a id="L325"></a><span > </span>
<a id="L326"></a><span > </span>
<a id="L327"></a><span class="visited"> </span>
<a id="L328"></a><span class="visited"> </span>
<a id="L329"></a><span class="unvisited"> </span>
<a id="L330"></a><span > </span>
<a id="L331"></a><span class="visited"> </span>
<a id="L332"></a><span > </span>
<a id="L333"></a><span class="visited"> </span>
<a id="L334"></a><span class="visited"> </span>
<a id="L335"></a><span class="visited"> </span>
<a id="L336"></a><span class="visited"> </span>
<a id="L337"></a><span class="visited"> </span>
<a id="L338"></a><span class="visited"> </span>
<a id="L339"></a><span > </span>
<a id="L340"></a><span class="visited"> </span>
<a id="L341"></a><span > </span>
<a id="L342"></a><span class="visited"> </span>
<a id="L343"></a><span > </span>
<a id="L344"></a><span > </span>
<a id="L345"></a><span class="visited"> </span>
<a id="L346"></a><span class="visited"> </span>
<a id="L347"></a><span class="unvisited"> </span>
<a id="L348"></a><span > </span>
<a id="L349"></a><span > </span>
<a id="L350"></a><span > </span>
<a id="L351"></a><span class="visited"> </span>
<a id="L352"></a><span class="visited"> </span>
<a id="L353"></a><span > </span>
<a id="L354"></a><span class="visited"> </span>
<a id="L355"></a><span class="visited"> </span>
<a id="L356"></a><span class="visited"> </span>
<a id="L357"></a><span > </span>
<a id="L358"></a><span class="visited"> </span>
<a id="L359"></a><span > </span>
<a id="L360"></a><span class="visited"> </span>
<a id="L361"></a><span class="visited"> </span>
<a id="L362"></a><span > </span>
<a id="L363"></a><span class="visited"> </span>
<a id="L364"></a><span > </span>
<a id="L365"></a><span class="visited"> </span>
<a id="L366"></a><span > </span>
<a id="L367"></a><span class="visited"> </span>
<a id="L368"></a><span > </span>
<a id="L369"></a><span class="visited"> </span>
<a id="L370"></a><span > </span>
<a id="L371"></a><span class="visited"> </span>
<a id="L372"></a><span class="visited"> </span>
<a id="L373"></a><span class="visited"> </span>
<a id="L374"></a><span class="unvisited"> </span>
<a id="L375"></a><span > </span>
<a id="L376"></a><span > </span>
<a id="L377"></a><span > </span>
<a id="L378"></a><span class="unvisited"> </span>
<a id="L379"></a><span class="unvisited"> </span>
<a id="L380"></a><span > </span>
<a id="L381"></a><span class="visited"> </span>
<a id="L382"></a><span class="visited"> </span>
<a id="L383"></a><span class="visited"> </span>
<a id="L384"></a><span class="visited"> </span>
<a id="L385"></a><span class="visited"> </span>
<a id="L386"></a><span > </span>
<a id="L387"></a><span class="visited"> </span>
<a id="L388"></a><span class="visited"> </span>
<a id="L389"></a><span > </span>
<a id="L390"></a><span class="visited"> </span>
<a id="L391"></a><span class="unvisited"> </span>
<a id="L392"></a><span > </span>
<a id="L393"></a><span > </span>
<a id="L394"></a><span class="visited"> </span>
<a id="L395"></a><span > </span>
<a id="L396"></a><span class="visited"> </span>
<a id="L397"></a><span class="visited"> </span>
<a id="L398"></a><span > </span>
<a id="L399"></a><span class="visited"> </span>
<a id="L400"></a><span class="visited"> </span>
<a id="L401"></a><span class="visited"> </span>
<a id="L402"></a><span > </span>
<a id="L403"></a><span > </span>
<a id="L404"></a><span > </span>
<a id="L405"></a><span > </span>
<a id="L406"></a><span > </span>
<a id="L407"></a><span class="visited"> </span>
<a id="L408"></a><span class="visited"> </span>
<a id="L409"></a><span class="visited"> </span>
<a id="L410"></a><span > </span>
<a id="L411"></a><span class="visited"> </span>
<a id="L412"></a><span class="visited"> </span>
<a id="L413"></a><span > </span>
<a id="L414"></a><span > </span>
<a id="L415"></a><span class="visited"> </span>
<a id="L416"></a><span > </span>
<a id="L417"></a><span > </span>
<a id="L418"></a><span class="visited"> </span>
<a id="L419"></a><span > </span>
<a id="L420"></a><span class="visited"> </span>
<a id="L421"></a><span class="visited"> </span>
<a id="L422"></a><span class="visited"> </span>
<a id="L423"></a><span class="visited"> </span>
<a id="L424"></a><span class="visited"> </span>
<a id="L425"></a><span class="visited"> </span>
<a id="L426"></a><span > </span>
<a id="L427"></a><span class="visited"> </span>
<a id="L428"></a><span class="visited"> </span>
<a id="L429"></a><span class="unvisited"> </span>
<a id="L430"></a><span > </span>
<a id="L431"></a><span > </span>
<a id="L432"></a><span > </span>
<a id="L433"></a><span class="visited"> </span>
<a id="L434"></a><span class="visited"> </span>
<a id="L435"></a><span > </span>
<a id="L436"></a><span > </span>
<a id="L437"></a><span > </span>
<a id="L438"></a><span > </span>
<a id="L439"></a><span > </span>
<a id="L440"></a><span class="visited"> </span>
<a id="L441"></a><span class="visited"> </span>
<a id="L442"></a><span class="visited"> </span>
<a id="L443"></a><span class="visited"> </span>
<a id="L444"></a><span class="visited"> </span>
<a id="L445"></a><span > </span>
<a id="L446"></a><span > </span>
<a id="L447"></a><span > </span>
<a id="L448"></a><span > </span>
<a id="L449"></a><span > </span>
<a id="L450"></a><span > </span>
<a id="L451"></a><span > </span>
<a id="L452"></a><span > </span>
<a id="L453"></a><span > </span>
<a id="L454"></a><span > </span>
<a id="L455"></a><span > </span>
<a id="L456"></a><span > </span>
<a id="L457"></a><span > </span>
<a id="L458"></a><span > </span>
<a id="L459"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
<a href="#L223">223</a>
<a href="#L224">224</a>
<a href="#L225">225</a>
<a href="#L226">226</a>
<a href="#L227">227</a>
<a href="#L228">228</a>
<a href="#L229">229</a>
<a href="#L230">230</a>
<a href="#L231">231</a>
<a href="#L232">232</a>
<a href="#L233">233</a>
<a href="#L234">234</a>
<a href="#L235">235</a>
<a href="#L236">236</a>
<a href="#L237">237</a>
<a href="#L238">238</a>
<a href="#L239">239</a>
<a href="#L240">240</a>
<a href="#L241">241</a>
<a href="#L242">242</a>
<a href="#L243">243</a>
<a href="#L244">244</a>
<a href="#L245">245</a>
<a href="#L246">246</a>
<a href="#L247">247</a>
<a href="#L248">248</a>
<a href="#L249">249</a>
<a href="#L250">250</a>
<a href="#L251">251</a>
<a href="#L252">252</a>
<a href="#L253">253</a>
<a href="#L254">254</a>
<a href="#L255">255</a>
<a href="#L256">256</a>
<a href="#L257">257</a>
<a href="#L258">258</a>
<a href="#L259">259</a>
<a href="#L260">260</a>
<a href="#L261">261</a>
<a href="#L262">262</a>
<a href="#L263">263</a>
<a href="#L264">264</a>
<a href="#L265">265</a>
<a href="#L266">266</a>
<a href="#L267">267</a>
<a href="#L268">268</a>
<a href="#L269">269</a>
<a href="#L270">270</a>
<a href="#L271">271</a>
<a href="#L272">272</a>
<a href="#L273">273</a>
<a href="#L274">274</a>
<a href="#L275">275</a>
<a href="#L276">276</a>
<a href="#L277">277</a>
<a href="#L278">278</a>
<a href="#L279">279</a>
<a href="#L280">280</a>
<a href="#L281">281</a>
<a href="#L282">282</a>
<a href="#L283">283</a>
<a href="#L284">284</a>
<a href="#L285">285</a>
<a href="#L286">286</a>
<a href="#L287">287</a>
<a href="#L288">288</a>
<a href="#L289">289</a>
<a href="#L290">290</a>
<a href="#L291">291</a>
<a href="#L292">292</a>
<a href="#L293">293</a>
<a href="#L294">294</a>
<a href="#L295">295</a>
<a href="#L296">296</a>
<a href="#L297">297</a>
<a href="#L298">298</a>
<a href="#L299">299</a>
<a href="#L300">300</a>
<a href="#L301">301</a>
<a href="#L302">302</a>
<a href="#L303">303</a>
<a href="#L304">304</a>
<a href="#L305">305</a>
<a href="#L306">306</a>
<a href="#L307">307</a>
<a href="#L308">308</a>
<a href="#L309">309</a>
<a href="#L310">310</a>
<a href="#L311">311</a>
<a href="#L312">312</a>
<a href="#L313">313</a>
<a href="#L314">314</a>
<a href="#L315">315</a>
<a href="#L316">316</a>
<a href="#L317">317</a>
<a href="#L318">318</a>
<a href="#L319">319</a>
<a href="#L320">320</a>
<a href="#L321">321</a>
<a href="#L322">322</a>
<a href="#L323">323</a>
<a href="#L324">324</a>
<a href="#L325">325</a>
<a href="#L326">326</a>
<a href="#L327">327</a>
<a href="#L328">328</a>
<a href="#L329">329</a>
<a href="#L330">330</a>
<a href="#L331">331</a>
<a href="#L332">332</a>
<a href="#L333">333</a>
<a href="#L334">334</a>
<a href="#L335">335</a>
<a href="#L336">336</a>
<a href="#L337">337</a>
<a href="#L338">338</a>
<a href="#L339">339</a>
<a href="#L340">340</a>
<a href="#L341">341</a>
<a href="#L342">342</a>
<a href="#L343">343</a>
<a href="#L344">344</a>
<a href="#L345">345</a>
<a href="#L346">346</a>
<a href="#L347">347</a>
<a href="#L348">348</a>
<a href="#L349">349</a>
<a href="#L350">350</a>
<a href="#L351">351</a>
<a href="#L352">352</a>
<a href="#L353">353</a>
<a href="#L354">354</a>
<a href="#L355">355</a>
<a href="#L356">356</a>
<a href="#L357">357</a>
<a href="#L358">358</a>
<a href="#L359">359</a>
<a href="#L360">360</a>
<a href="#L361">361</a>
<a href="#L362">362</a>
<a href="#L363">363</a>
<a href="#L364">364</a>
<a href="#L365">365</a>
<a href="#L366">366</a>
<a href="#L367">367</a>
<a href="#L368">368</a>
<a href="#L369">369</a>
<a href="#L370">370</a>
<a href="#L371">371</a>
<a href="#L372">372</a>
<a href="#L373">373</a>
<a href="#L374">374</a>
<a href="#L375">375</a>
<a href="#L376">376</a>
<a href="#L377">377</a>
<a href="#L378">378</a>
<a href="#L379">379</a>
<a href="#L380">380</a>
<a href="#L381">381</a>
<a href="#L382">382</a>
<a href="#L383">383</a>
<a href="#L384">384</a>
<a href="#L385">385</a>
<a href="#L386">386</a>
<a href="#L387">387</a>
<a href="#L388">388</a>
<a href="#L389">389</a>
<a href="#L390">390</a>
<a href="#L391">391</a>
<a href="#L392">392</a>
<a href="#L393">393</a>
<a href="#L394">394</a>
<a href="#L395">395</a>
<a href="#L396">396</a>
<a href="#L397">397</a>
<a href="#L398">398</a>
<a href="#L399">399</a>
<a href="#L400">400</a>
<a href="#L401">401</a>
<a href="#L402">402</a>
<a href="#L403">403</a>
<a href="#L404">404</a>
<a href="#L405">405</a>
<a href="#L406">406</a>
<a href="#L407">407</a>
<a href="#L408">408</a>
<a href="#L409">409</a>
<a href="#L410">410</a>
<a href="#L411">411</a>
<a href="#L412">412</a>
<a href="#L413">413</a>
<a href="#L414">414</a>
<a href="#L415">415</a>
<a href="#L416">416</a>
<a href="#L417">417</a>
<a href="#L418">418</a>
<a href="#L419">419</a>
<a href="#L420">420</a>
<a href="#L421">421</a>
<a href="#L422">422</a>
<a href="#L423">423</a>
<a href="#L424">424</a>
<a href="#L425">425</a>
<a href="#L426">426</a>
<a href="#L427">427</a>
<a href="#L428">428</a>
<a href="#L429">429</a>
<a href="#L430">430</a>
<a href="#L431">431</a>
<a href="#L432">432</a>
<a href="#L433">433</a>
<a href="#L434">434</a>
<a href="#L435">435</a>
<a href="#L436">436</a>
<a href="#L437">437</a>
<a href="#L438">438</a>
<a href="#L439">439</a>
<a href="#L440">440</a>
<a href="#L441">441</a>
<a href="#L442">442</a>
<a href="#L443">443</a>
<a href="#L444">444</a>
<a href="#L445">445</a>
<a href="#L446">446</a>
<a href="#L447">447</a>
<a href="#L448">448</a>
<a href="#L449">449</a>
<a href="#L450">450</a>
<a href="#L451">451</a>
<a href="#L452">452</a>
<a href="#L453">453</a>
<a href="#L454">454</a>
<a href="#L455">455</a>
<a href="#L456">456</a>
<a href="#L457">457</a>
<a href="#L458">458</a>
<a href="#L459">459</a>
</pre>
<pre><code class="ocaml">(** Copyright 2021-2024, DmitryPilyuk and raf-nr *)

(** SPDX-License-Identifier: LGPL-3.0-or-later *)

open Ast
open Values
open Int_errors

module type MONAD_ERROR = sig
  type ('a, 'e) t

  val return : 'a -&gt; ('a, 'e) t
  val fail : 'e -&gt; ('a, 'e) t
  val ( &gt;&gt;= ) : ('a, 'e) t -&gt; ('a -&gt; ('b, 'e) t) -&gt; ('b, 'e) t
  val ( let* ) : ('a, 'e) t -&gt; ('a -&gt; ('b, 'e) t) -&gt; ('b, 'e) t
end

module Env (M : MONAD_ERROR) = struct
  (* The environment is map, in which the key is string -
     the name of the let binding or the name of the effect,
     and the value is the result of the interpreter ('value'). *)
  open M

  type t = enviroment

  let empty : t = Base.Map.empt<span data-count="66">y</span> (module Base.String)
  let find env k = <span data-count="922">B</span>ase.Map.find env k
  let extend env key value = <span data-count="1430">B</span>ase.Map.update env key ~f:(fun _ -&gt; <span data-count="1430">v</span>alue)

  let compose env1 env2 =
    <span data-count="605">B</span>ase.Map.fold env2 ~init:env1 ~f:(fun ~key ~data acc_env -&gt; <span data-count="621">e</span>xtend acc_env key data)
  ;;

  let find_var env name =
    <span data-count="863">m</span>atch find env name with
    | <span data-count="863">S</span>ome v -&gt; return v
    | <span data-count="0">N</span>one -&gt; fail (unbound_variabl<span data-count="0">e</span> name)
  ;;

  let find_effect env name =
    <span data-count="41">m</span>atch find env name with
    | <span data-count="41">S</span>ome v -&gt; return v
    | <span data-count="0">N</span>one -&gt; fail (unbound_effec<span data-count="0">t</span> name)
  ;;
end

module Handlers (M : MONAD_ERROR) = struct
  (* The handlers environment is map, where the key is string -
     the name of the effect, and the value is a tuple of three elements
     - the handler of this effect. *)
  open M

  type t = handlers

  let empty_handler : t = Base.Map.empt<span data-count="33">y</span> (module Base.String)
  let find_handler env k = <span data-count="19">B</span>ase.Map.find env k
  let extend_handler env key value = <span data-count="25">B</span>ase.Map.update env key ~f:(fun _ -&gt; <span data-count="25">v</span>alue)

  let find_handler handlers name =
    <span data-count="19">m</span>atch find_handler handlers name with
    | <span data-count="18">S</span>ome v -&gt; return v
    | <span data-count="1">N</span>one -&gt; fail (unbound_handle<span data-count="1">r</span> name)
  ;;
end

module Pattern (M : MONAD_ERROR) = struct
  open M
  open Env (M)

  type match_flag =
    | Successful (* The pattern is matched to the value. *)
    | UnSuccessful (* The pattern isn't matched to the value. *)

  let eval_const_pattern env pat v =
    <span data-count="141">m</span>atch pat, v with
    | <span data-count="12">I</span>nt i1, VInt i2 when i1 = i2 -&gt; <span data-count="4">r</span>eturn (Successful, env)
    | <span data-count="17">B</span>ool b1, VBool b2 when b1 = b2 -&gt; <span data-count="12">r</span>eturn (Successful, env)
    | <span data-count="109">C</span>har c1, VChar c2 when c1 = c2 -&gt; <span data-count="16">r</span>eturn (Successful, env)
    | <span data-count="1">S</span>tring s1, VString s2 when s1 = s2 -&gt; <span data-count="1">r</span>eturn (Successful, env)
    | <span data-count="2">U</span>nit, VUnit -&gt; return (Successful, env)
    | <span data-count="8">I</span>nt _, VInt _ | <span data-count="5">B</span>ool _, VBool _ | <span data-count="93">C</span>har _, VChar _ | <span data-count="0">S</span>tring _, VString _ -&gt;
      return (UnSuccessful, env)
    | <span data-count="0">_</span> -&gt; fail type_error
  ;;

  let rec eval_pattern pat v =
    (* The function tries to match the pattern and the value.
       If it succeeds, it returns a tuple of the successful matching flag
       and the environment in which the pattern was defined. *)
    <span data-count="880">l</span>et env = empty in
    let helper =
      match pat, v with
      | <span data-count="3">P</span>Any, _ -&gt; retur<span data-count="3">n</span> (Successful, env)
      | <span data-count="141">P</span>Const i, v -&gt; eval_const_patter<span data-count="141">n</span> env i v
      | <span data-count="12">P</span>Nill, VList [] -&gt; retur<span data-count="12">n</span> (Successful, env)
      | <span data-count="74">P</span>Nill, VList _ -&gt; retur<span data-count="74">n</span> (UnSuccessful, env)
      | <span data-count="541">P</span>Val name, v -&gt;
        let new_env = extend env name v in
        <span data-count="541">r</span>etur<span data-count="541">n</span> (Successful, new_env)
      | <span data-count="11">P</span>Tuple pats, VTuple vs -&gt;
        let rec match_tuple env = function
          | <span data-count="4">[</span>], [] -&gt; return (Successful, env)
          | <span data-count="22">p</span>at :: pats, v :: vs -&gt;
            let* flag, pat_env = eval_patter<span data-count="22">n</span> pat v in
            <span data-count="22">l</span>et new_env = compose env pat_env in
            <span data-count="22">l</span>et result =
              match flag with
              | <span data-count="15">S</span>uccessful -&gt; match_tupl<span data-count="15">e</span> new_env (pats, vs)
              | <span data-count="7">U</span>nSuccessful -&gt; retur<span data-count="7">n</span> (UnSuccessful, new_env)
            in
            result
          | <span data-count="0">_</span> -&gt; return (UnSuccessful, env)
        in
        match_tupl<span data-count="11">e</span> env (pats, vs)
      | <span data-count="75">P</span>ListCons (pat1, pat2), VList (v1 :: v2) -&gt;
        let* flag1, pat_env1 = eval_patter<span data-count="75">n</span> pat1 v1 in
        <span data-count="75">l</span>et* flag2, pat_env2 = eval_patter<span data-count="75">n</span> pat2 (VList v2) in
        <span data-count="75">(</span>match flag1, flag2 with
         | <span data-count="74">S</span>uccessful, Successful -&gt;
           let combined_env = compose pat_env1 pat_env2 in
           <span data-count="74">r</span>eturn (Successful, combined_env)
         | <span data-count="1">_</span> -&gt; return (UnSuccessful, env))
      | <span data-count="1">P</span>ListCons _, VList _ -&gt; retur<span data-count="1">n</span> (UnSuccessful, env)
      | <span data-count="6">P</span>EffectWithoutArguments name1, VEffectWithoutArguments name2 -&gt;
        (match name1 = name2 with
         | <span data-count="4">t</span>rue -&gt; retur<span data-count="4">n</span> (Successful, env)
         | <span data-count="2">f</span>alse -&gt; retur<span data-count="2">n</span> (UnSuccessful, env))
      | <span data-count="16">P</span>EffectWithArguments (name1, pattern1), VEffectWithArguments (name2, value2) -&gt;
        (match name1 = name2 with
         | <span data-count="0">f</span>alse -&gt; retur<span data-count="0">n</span> (UnSuccessful, env)
         | <span data-count="16">t</span>rue -&gt;
           let* flag, new_env = eval_patter<span data-count="16">n</span> pattern1 value2 in
           <span data-count="16">(</span>match flag with
            | <span data-count="16">S</span>uccessful -&gt; return (Successful, new_env)
            | <span data-count="0">U</span>nSuccessful -&gt; return (UnSuccessful, env)))
      | <span data-count="0">_</span> -&gt; fai<span data-count="0">l</span> type_error
    in
    helper
  ;;
end

module Interpreter (M : MONAD_ERROR) = struct
  open M
  open Env (M)
  open Handlers (M)
  open Pattern (M)

  let eval_const env = function
    | <span data-count="362">I</span>nt i -&gt; return (env, vin<span data-count="362">t</span> i)
    | <span data-count="58">B</span>ool b -&gt; return (env, vboo<span data-count="58">l</span> b)
    | <span data-count="17">U</span>nit -&gt; return (env, vunit)
    | <span data-count="39">C</span>har c -&gt; return (env, vcha<span data-count="39">r</span> c)
    | <span data-count="17">S</span>tring s -&gt; return (env, vstrin<span data-count="17">g</span> s)
  ;;

  let eval_un_op env = function
    | <span data-count="7">P</span>lus, VInt i -&gt; return (env, vin<span data-count="7">t</span> (<span data-count="7">+</span>i))
    | <span data-count="17">M</span>inus, VInt i -&gt; return (env, vin<span data-count="17">t</span> (<span data-count="17">-</span>i))
    | <span data-count="8">N</span>ot, VBool b -&gt; return (env, vboo<span data-count="8">l</span> (not b))
    | <span data-count="0">P</span>lus, _ | <span data-count="0">M</span>inus, _ | <span data-count="0">N</span>ot, _ -&gt; fail type_error
  ;;

  let eval_bin_op env = function
    (* + - * / *)
    | <span data-count="74">A</span>dd, VInt i1, VInt i2 -&gt; return (env, vin<span data-count="74">t</span> (i1 + i2))
    | <span data-count="39">S</span>ub, VInt i1, VInt i2 -&gt; return (env, vin<span data-count="39">t</span> (i1 - i2))
    | <span data-count="19">M</span>ul, VInt i1, VInt i2 -&gt; return (env, vin<span data-count="19">t</span> (i1 * i2))
    | <span data-count="5">D</span>iv, VInt i1, VInt i2 -&gt;
      let res =
        match i2 with
        | <span data-count="1">0</span> -&gt; fai<span data-count="1">l</span> division_by_zero
        | <span data-count="4">_</span> -&gt; retur<span data-count="4">n</span> (env, vin<span data-count="4">t</span> (i1 / i2))
      in
      res
    (* &amp;&amp; || *)
    | <span data-count="47">A</span>nd, VBool b1, VBool b2 -&gt; return (env, vboo<span data-count="47">l</span> (b1 &amp;&amp; <span data-count="42">b</span>2))
    | <span data-count="27">O</span>r, VBool b1, VBool b2 -&gt; return (env, vboo<span data-count="27">l</span> (b<span data-count="10">1</span> || b<span data-count="11">2</span>))
    (* = *)
    | <span data-count="54">E</span>q, VInt i1, VInt i2 -&gt; return (env, vboo<span data-count="54">l</span> (i1 = i2))
    | <span data-count="2">E</span>q, VChar c1, VChar c2 -&gt; return (env, vboo<span data-count="2">l</span> (c1 = c2))
    | <span data-count="2">E</span>q, VString s1, VString s2 -&gt; return (env, vboo<span data-count="2">l</span> (s1 = s2))
    | <span data-count="3">E</span>q, VBool b1, VBool b2 -&gt; return (env, vboo<span data-count="3">l</span> (b1 = b2))
    | <span data-count="2">E</span>q, VUnit, VUnit -&gt; return (env, vboo<span data-count="2">l</span> true)
    (* &lt;&gt; or != *)
    | <span data-count="2">N</span>Eq, VInt i1, VInt i2 -&gt; return (env, vboo<span data-count="2">l</span> (i1 &lt;&gt; i2))
    | <span data-count="2">N</span>Eq, VChar c1, VChar c2 -&gt; return (env, vboo<span data-count="2">l</span> (c1 &lt;&gt; c2))
    | <span data-count="1">N</span>Eq, VString s1, VString s2 -&gt; return (env, vboo<span data-count="1">l</span> (s1 &lt;&gt; s2))
    | <span data-count="1">N</span>Eq, VBool b1, VBool b2 -&gt; return (env, vboo<span data-count="1">l</span> (b1 &lt;&gt; b2))
    | <span data-count="1">N</span>Eq, VUnit, VUnit -&gt; return (env, vboo<span data-count="1">l</span> false)
    (* &gt; *)
    | <span data-count="26">G</span>t, VInt i1, VInt i2 -&gt; return (env, vboo<span data-count="26">l</span> (i1 &gt; i2))
    | <span data-count="1">G</span>t, VBool _, VBool _ -&gt; return (env, vboo<span data-count="1">l</span> false)
    | <span data-count="1">G</span>t, VChar c1, VChar c2 -&gt; return (env, vboo<span data-count="1">l</span> (c1 &gt; c2))
    | <span data-count="1">G</span>t, VString s1, VString s2 -&gt; return (env, vboo<span data-count="1">l</span> (s1 &gt; s2))
    | <span data-count="1">G</span>t, VUnit, VUnit -&gt; return (env, vboo<span data-count="1">l</span> false)
    (* &lt; *)
    | <span data-count="15">L</span>t, VInt i1, VInt i2 -&gt; return (env, vboo<span data-count="15">l</span> (i1 &lt; i2))
    | <span data-count="1">L</span>t, VBool _, VBool _ -&gt; return (env, vboo<span data-count="1">l</span> false)
    | <span data-count="1">L</span>t, VChar c1, VChar c2 -&gt; return (env, vboo<span data-count="1">l</span> (c1 &lt; c2))
    | <span data-count="1">L</span>t, VString s1, VString s2 -&gt; return (env, vboo<span data-count="1">l</span> (s1 &lt; s2))
    | <span data-count="1">L</span>t, VUnit, VUnit -&gt; return (env, vboo<span data-count="1">l</span> false)
    (* &gt;= *)
    | <span data-count="6">G</span>te, VInt i1, VInt i2 -&gt; return (env, vboo<span data-count="6">l</span> (i1 &gt;= i2))
    | <span data-count="1">G</span>te, VBool b1, VBool b2 -&gt; return (env, vboo<span data-count="1">l</span> (b1 &gt;= b2))
    | <span data-count="1">G</span>te, VChar c1, VChar c2 -&gt; return (env, vboo<span data-count="1">l</span> (c1 &gt;= c2))
    | <span data-count="1">G</span>te, VString s1, VString s2 -&gt; return (env, vboo<span data-count="1">l</span> (s1 &gt;= s2))
    | <span data-count="1">G</span>te, VUnit, VUnit -&gt; return (env, vboo<span data-count="1">l</span> false)
    (* &lt;= *)
    | <span data-count="3">L</span>te, VInt i1, VInt i2 -&gt; return (env, vboo<span data-count="3">l</span> (i1 &lt;= i2))
    | <span data-count="1">L</span>te, VBool b1, VBool b2 -&gt; return (env, vboo<span data-count="1">l</span> (b1 &lt;= b2))
    | <span data-count="1">L</span>te, VChar c1, VChar c2 -&gt; return (env, vboo<span data-count="1">l</span> (c1 &lt;= c2))
    | <span data-count="1">L</span>te, VString s1, VString s2 -&gt; return (env, vboo<span data-count="1">l</span> (s1 &lt;= s2))
    | <span data-count="1">L</span>te, VUnit, VUnit -&gt; return (env, vboo<span data-count="1">l</span> false)
    (* Operand type mismatch. *)
    | <span data-count="0">_</span> -&gt; fail type_error
  ;;

  let eval_handler handler v =
    (* Used in perform to match the handler pattern and the effect. *)
    <span data-count="18">m</span>atch handler, v with
    | <span data-count="2">(</span>p, _, _), VEffectWithoutArguments _ | <span data-count="16">(</span>p, _, _), VEffectWithArguments _ -&gt;
      eval_pattern p v
    | <span data-count="0">_</span> -&gt; fail type_error
  ;;

  let eval_expr =
    let rec helper env handlers = function
      (* Environment in the return value is needed for type compatibility
         and correct operation of EDeclaration and ERecDeclaration. Passing
         handlers to each helper is necessary for type compatibility and
         correct operation of ETryWith. *)
      | <span data-count="493">E</span>Const c -&gt; eval_const env c
      | <span data-count="863">E</span>Identifier name -&gt;
        let* v = find_va<span data-count="863">r</span> env name in
        <span data-count="863">r</span>eturn (env, v)
      | <span data-count="32">E</span>UnaryOperation (op, expr) -&gt;
        let* _, v = helpe<span data-count="32">r</span> env handlers expr in
        <span data-count="32">l</span>et res = eval_un_op env (op, v) in
        <span data-count="32">r</span>es
      | <span data-count="347">E</span>BinaryOperation (op, expr1, expr2) -&gt;
        let* _, v1 = helpe<span data-count="347">r</span> env handlers expr1 in
        <span data-count="347">l</span>et* _, v2 = helpe<span data-count="347">r</span> env handlers expr2 in
        <span data-count="347">l</span>et res = eval_bin_op env (op, v1, v2) in
        <span data-count="347">r</span>es
      | <span data-count="62">E</span>IfThenElse (cond, b1, b2) -&gt;
        let* _, v = helpe<span data-count="62">r</span> env handlers cond in
        <span data-count="62">l</span>et res =
          match v with
          | <span data-count="31">V</span>Bool true -&gt; helpe<span data-count="31">r</span> env handlers b1
          | <span data-count="31">V</span>Bool false -&gt; helpe<span data-count="31">r</span> env handlers b2
          | <span data-count="0">_</span> -&gt; fai<span data-count="0">l</span> type_error
        in
        res
      | <span data-count="174">E</span>Fun (pat, expr) -&gt; return (env, vfu<span data-count="174">n</span> pat expr env)
      | <span data-count="15">E</span>Tuple expr_list -&gt;
        let* _, values = list_and_tuple_helpe<span data-count="15">r</span> env expr_list in
        <span data-count="15">r</span>eturn (env, vtupl<span data-count="15">e</span> values)
      | <span data-count="25">E</span>List expr_list -&gt;
        let* _, values = list_and_tuple_helpe<span data-count="25">r</span> env expr_list in
        <span data-count="25">r</span>eturn (env, vlis<span data-count="25">t</span> values)
      | <span data-count="43">E</span>ListCons (e1, e2) -&gt;
        let* _, v1 = helpe<span data-count="43">r</span> env handlers e1 in
        <span data-count="43">l</span>et* _, v2 = helpe<span data-count="43">r</span> env handlers e2 in
        <span data-count="43">l</span>et* values =
          match v2 with
          | <span data-count="43">V</span>List v -&gt; retur<span data-count="43">n</span> (v1 :: v)
          | <span data-count="0">_</span> -&gt; fai<span data-count="0">l</span> type_error
        in
        <span data-count="43">r</span>eturn (env, vlis<span data-count="43">t</span> values)
      | <span data-count="9">E</span>LetIn (name, expr, expression) -&gt;
        let* env, v = helpe<span data-count="9">r</span> env handlers expr in
        <span data-count="9">l</span>et new_env = extend env name v in
        <span data-count="9">l</span>et* _, v = helpe<span data-count="9">r</span> new_env handlers expression in
        <span data-count="7">r</span>eturn (env, v)
      | <span data-count="7">E</span>RecLetIn (name, expr, expression) -&gt;
        let* new_env, _ = rec_declaration_helpe<span data-count="7">r</span> env handlers name expr in
        <span data-count="7">l</span>et* _, v = helpe<span data-count="7">r</span> new_env handlers expression in
        <span data-count="7">r</span>eturn (env, v)
      | <span data-count="364">E</span>Application (f, e) -&gt;
        let* _, v1 = helpe<span data-count="364">r</span> env handlers f in
        <span data-count="364">l</span>et* _, v2 = helpe<span data-count="364">r</span> env handlers e in
        <span data-count="364">(</span>match v1 with
         | <span data-count="240">V</span>Fun (pat, exp, fun_env) -&gt;
           let* flag, pat_env = eval_patter<span data-count="240">n</span> pat v2 in
           <span data-count="240">a</span>pplication_helper flag fun_env pat_env env handlers exp
         | <span data-count="124">V</span>RecFun (name, v) -&gt;
           (match v with
            | <span data-count="124">V</span>Fun (pat, exp, fun_env) -&gt;
              let fun_env = extend fun_env name v1 in
              <span data-count="124">l</span>et* flag, pat_env = eval_patter<span data-count="124">n</span> pat v2 in
              <span data-count="124">a</span>pplication_helper flag fun_env pat_env env handlers exp
            | <span data-count="0">_</span> -&gt; fail type_error)
         | <span data-count="0">_</span> -&gt; fail type_error)
      | <span data-count="17">E</span>EffectWithArguments (name, expr) -&gt;
        let* _ = find_effec<span data-count="17">t</span> env name in
        <span data-count="17">l</span>et* _, v1 = helpe<span data-count="17">r</span> env handlers expr in
        <span data-count="17">l</span>et v2 = veffect_with_arguments name v1 in
        <span data-count="17">r</span>eturn (env, v2)
      | <span data-count="5">E</span>EffectWithoutArguments name -&gt;
        let* _ = find_effec<span data-count="5">t</span> env name in
        <span data-count="5">l</span>et v = veffect_without_arguments name in
        <span data-count="5">r</span>eturn (env, v)
      | <span data-count="132">E</span>MatchWith (expr, cases) -&gt;
        let* _, v = helpe<span data-count="132">r</span> env handlers expr in
        <span data-count="132">l</span>et rec match_cases env = function
          | <span data-count="4">[</span>] -&gt; fail pattern_matching_failure
          | <span data-count="310">(</span>pat, expr) :: rest -&gt;
            let* flag, env' = eval_patter<span data-count="310">n</span> pat v in
            <span data-count="310">(</span>match flag with
             | <span data-count="128">S</span>uccessful -&gt;
               let env'' = compose env env' in
               <span data-count="128">l</span>et* _, result = helpe<span data-count="128">r</span> env'' handlers expr in
               <span data-count="128">r</span>eturn (env, result)
             | <span data-count="182">U</span>nSuccessful -&gt; match_cases env rest)
        in
        match_cases env cases
      | <span data-count="17">E</span>TryWith (expr, body) -&gt;
        (* Go through all the effect handlers and add them to the handler environment. *)
        (* And then, using this environment - calculate the expr at which the effect can perform. *)
        let rec trywith_helper handlers = function
          | <span data-count="17">[</span>] -&gt; return handlers
          | <span data-count="25">h</span>d :: tl -&gt;
            (match hd with
             | <span data-count="25">E</span>ffectHandler (pat, expr, cont) -&gt;
               let* handlers =
                 match pat with
                 | <span data-count="3">P</span>EffectWithoutArguments name | <span data-count="22">P</span>EffectWithArguments (name, _) -&gt;
                   retur<span data-count="25">n</span> (extend_handle<span data-count="25">r</span> handlers name (pat, expr, cont))
                 | <span data-count="0">_</span> -&gt; fai<span data-count="0">l</span> type_error
               in
               <span data-count="25">t</span>rywith_helper handlers tl)
        in
        let* handlers = trywith_helpe<span data-count="17">r</span> handlers body in
        <span data-count="17">l</span>et* _, v = helpe<span data-count="17">r</span> env handlers expr in
        <span data-count="16">r</span>eturn (env, v)
      | <span data-count="18">E</span>EffectContinue (cont, expr) -&gt;
        let* _, v = helpe<span data-count="18">r</span> env handlers expr in
        <span data-count="18">l</span>et* cont =
          match cont with
          | <span data-count="18">C</span>ontinue k -&gt; retur<span data-count="18">n</span> k
        in
        <span data-count="18">l</span>et res =
          (* Check that the continuation variable is defined. *)
          match find env cont with
          | <span data-count="18">S</span>ome (VEffectContinue (Continue n)) when n = cont -&gt;
            <span data-count="18">r</span>etur<span data-count="18">n</span> (env, vthrowing_valu<span data-count="18">e</span> v) (* Transfer the value. *)
          | <span data-count="0">_</span> -&gt; fai<span data-count="0">l</span> (not_continue_va<span data-count="0">r</span> cont)
          (* If the variable is not a continuation point. *)
        in
        res
      | <span data-count="19">E</span>EffectPerform expr -&gt;
        let* _, v = helpe<span data-count="19">r</span> env handlers expr in
        (* count the effect inside perform. *)
        <span data-count="19">(</span>match v with
         | <span data-count="17">V</span>EffectWithArguments (name, _) | <span data-count="2">V</span>EffectWithoutArguments name -&gt;
           let* _ = find_effec<span data-count="19">t</span> env name in
           (* Check that the effect is defined. *)
           <span data-count="19">l</span>et* handler = find_handle<span data-count="19">r</span> handlers name in
           (* Check that the handler is defined. *)
           <span data-count="18">l</span>et* flag, pat_env = eval_handle<span data-count="18">r</span> handler v in
           <span data-count="18">l</span>et _, expr, cont = handler in
           (match flag with
            | <span data-count="18">S</span>uccessful -&gt;
              let new_env = compose env pat_env in
              <span data-count="18">l</span>et* cont_val =
                match cont with
                | <span data-count="18">C</span>ontinue k -&gt; retur<span data-count="18">n</span> k
              in
              <span data-count="18">l</span>et new_env = extend new_env cont_val (veffect_continu<span data-count="18">e</span> cont) in
              (* Set a continuation point. *)
              <span data-count="18">l</span>et* _, v = helpe<span data-count="18">r</span> new_env handlers expr in
              <span data-count="18">(</span>match v with
               | <span data-count="18">V</span>ThrowingValue n -&gt; return (env, n)
               | <span data-count="0">_</span> -&gt; fail (handler_without_continu<span data-count="0">e</span> name))
              (* Here evaluate the expression in the handler (there should be continue).
                 If it throws a value, we return it. If something else,
                 give an error, since ordinary exceptions are not processed. *)
            | <span data-count="0">U</span>nSuccessful -&gt; fail pattern_matching_failure)
         | <span data-count="0">_</span> -&gt; fail type_error)
    and list_and_tuple_helper env = function
      | <span data-count="40">[</span>] -&gt; return (env, [])
      | <span data-count="102">e</span>xpr :: rest -&gt;
        let* env, value = helpe<span data-count="102">r</span> env empty_handler expr in
        <span data-count="102">l</span>et* env, rest_values = list_and_tuple_helpe<span data-count="102">r</span> env rest in
        <span data-count="102">r</span>eturn (env, value :: rest_values)
    and rec_declaration_helper env handlers name expr =
      <span data-count="7">l</span>et* env, v = helpe<span data-count="7">r</span> env handlers expr in
      <span data-count="7">l</span>et res =
        match v with
        | <span data-count="7">V</span>Fun (_, _, _) -&gt; vrecfu<span data-count="7">n</span> name v
        | <span data-count="0">_</span> -&gt; v
      in
      let new_env = extend env name res in
      <span data-count="7">r</span>eturn (new_env, res)
    and application_helper flag fun_env pat_env env handlers exp =
      <span data-count="364">m</span>atch flag with
      | <span data-count="363">S</span>uccessful -&gt;
        let new_env = compose fun_env pat_env in
        <span data-count="363">l</span>et* _, v = helpe<span data-count="363">r</span> new_env handlers exp in
        <span data-count="359">r</span>eturn (env, v)
      | <span data-count="1">U</span>nSuccessful -&gt; fail pattern_matching_failure
    in
    helper
  ;;

  let eval env handlers =
    <span data-count="113">l</span>et rec_declaration_helper env handlers name expr =
      <span data-count="9">l</span>et* env, v = eval_exp<span data-count="9">r</span> env handlers expr in
      <span data-count="9">l</span>et res =
        match v with
        | <span data-count="8">V</span>Fun (_, _, _) -&gt; vrecfu<span data-count="8">n</span> name v
        | <span data-count="1">_</span> -&gt; v
      in
      let new_env = extend env name res in
      <span data-count="9">r</span>eturn (new_env, res)
    in
    function
    | <span data-count="113">S</span>Declaration decl -&gt;
      (match decl with
       | <span data-count="88">D</span>Declaration (name, expr) -&gt;
         let* env, v = eval_exp<span data-count="88">r</span> env handlers expr in
         <span data-count="85">l</span>et new_env = extend env name v in
         <span data-count="85">r</span>eturn (new_env, v)
       | <span data-count="9">D</span>RecDeclaration (name, expr) -&gt; rec_declaration_helper env handlers name expr
       | <span data-count="16">D</span>EffectDeclaration (name, _) -&gt;
         let v = veffect_declaration name in
         <span data-count="16">l</span>et new_env = extend env name v in
         <span data-count="16">r</span>eturn (new_env, v))
    | <span data-count="0">S</span>Expression expr -&gt; eval_expr env handlers expr
  ;;

  let interpret_expr expr =
    <span data-count="35">l</span>et* _, v = eval_exp<span data-count="35">r</span> empty empty_handler expr in
    <span data-count="31">r</span>eturn v
  ;;

  let interpret_program program =
    (* The result of the program is an enviroment
       in which all let bindings and effects and their values are defined. *)
    <span data-count="31">l</span>et rec run_helper env handlers = function
      | <span data-count="28">[</span>] -&gt; return env
      | <span data-count="113">e</span>xpr :: rest -&gt;
        let* new_env, _ = eva<span data-count="113">l</span> env handlers expr in
        <span data-count="110">r</span>un_helper new_env handlers rest
    in
    run_helper empty empty_handler program
  ;;
end

module RESULT_MONAD_ERROR = struct
  include Base.Result

  let ( let* ) = ( &gt;&gt;= )
end

module InterpreterWithResultMonad = Interpreter (RESULT_MONAD_ERROR)

let run_expr_interpreter = InterpreterWithResultMonad.interpret_expr
let run_program_interpreter = InterpreterWithResultMonad.interpret_program
</code></pre>
      </div>
    </div>
    <script src="../../coverage.js"></script>
  </body>
</html>
